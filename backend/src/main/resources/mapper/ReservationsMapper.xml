<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.apple.arentcar.mapper.ReservationsMapper">

    <!-- 간략한 예약 데이터 보기 및 조건 조회 -->
    <select id="getReservations"
            parameterType="com.apple.arentcar.dto.ReservationsSearchRequestDTO"
            resultType="com.apple.arentcar.dto.ReservationsResponseDTO">
        SELECT
        r.reservation_code,
        u.user_name,
        rc.car_number,
        ct.car_type_name,
        rl.branch_name AS rentalLocationName,
        r.rental_date AS rentalDate,
        r.return_date AS returnDate
        FROM reservations r
        JOIN users u ON r.user_code = u.user_code
        JOIN rental_cars rc ON r.car_code = rc.car_code
        JOIN car_types ct ON rc.car_type_code = ct.car_type_code
        JOIN branchs rl ON r.rental_location = rl.branch_code
        WHERE 1=1
        <if test="rentalLocationName != null and rentalLocationName != ''">
            AND rl.branch_name = #{rentalLocationName}
        </if>
        <if test="rentalDate != null and rentalDate != ''">
            AND r.rental_date = DATE_FORMAT(#{rentalDate},'%Y%m%d')
        </if>
        <if test="userName != null and userName != ''">
            AND u.user_name = #{userName}
        </if>
        ORDER BY r.rental_date DESC
        LIMIT #{pageNumber}, #{pageSize}
    </select>

    <!-- Insert -->
    <insert id="createReservation" parameterType="com.apple.arentcar.model.Reservations">
        INSERT INTO reservations (
        user_code, car_code, rental_location, rental_date, rental_time,
        return_location, return_date, return_time, insurance_type,
        payment_category, payment_type, payment_amount, created_at, updated_at
        ) VALUES (
        #{userCode}, #{carCode}, #{rentalLocation}, #{rentalDate}, #{rentalTime},
        #{returnLocation}, #{returnDate}, #{returnTime}, #{insuranceType},
        #{paymentCategory}, #{paymentType}, #{paymentAmount}, NOW(), NOW()
        )
    </insert>

    <!-- Update -->
    <update id="updateReservationById" parameterType="com.apple.arentcar.model.Reservations">
        UPDATE reservations
        SET
        user_code = #{userCode},
        car_code = #{carCode},
        rental_location = #{rentalLocation},
        rental_date = #{rentalDate},
        rental_time = #{rentalTime},
        return_location = #{returnLocation},
        return_date = #{returnDate},
        return_time = #{returnTime},
        insurance_type = #{insuranceType},
        payment_category = #{paymentCategory},
        payment_type = #{paymentType},
        payment_amount = #{paymentAmount},
        updated_at = NOW()
        WHERE reservation_code = #{reservationCode}
    </update>

    <!-- Delete -->
    <delete id="deleteReservationById">
        DELETE FROM reservations
        WHERE reservation_code = #{reservationCode}
    </delete>
</mapper>
