<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.apple.arentcar.mapper.ReservationsMapper">

    <!-- 간략한 예약 데이터 보기 및 조건 조회 -->
    <select id="getReservations"
            parameterType="com.apple.arentcar.dto.ReservationsSearchRequestDTO"
            resultType="com.apple.arentcar.dto.ReservationsResponseDTO">
        SELECT
        r.reservation_code,
        u.user_name,
        rc.car_number,
        ct.car_type_name,
        rl.branch_name AS rentalLocationName,
        DATE_FORMAT(r.rental_date, '%Y-%m-%d') AS rentalDate,  <!-- 날짜 변환 -->
        DATE_FORMAT(r.return_date, '%Y-%m-%d') AS returnDate  <!-- 날짜 변환 -->
        FROM reservations r
        JOIN users u ON r.user_code = u.user_code
        JOIN rental_cars rc ON r.car_code = rc.car_code
        JOIN car_types ct ON rc.car_type_code = ct.car_type_code
        JOIN branchs rl ON r.rental_location = rl.branch_code
        WHERE 1=1
        <if test="rentalLocationName != null and rentalLocationName != ''">
            AND rl.branch_name = #{rentalLocationName}
        </if>
        <if test="rentalDate != null and rentalDate != ''">
            AND r.rental_date = DATE_FORMAT(#{rentalDate}, '%Y%m%d')
        </if>
        <if test="userName != null and userName != ''">
            AND u.user_name = #{userName}
        </if>
        ORDER BY r.rental_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countByConditions" parameterType="com.apple.arentcar.dto.ReservationsSearchRequestDTO" resultType="int">
        SELECT COUNT(*)
        FROM reservations r
        JOIN users u ON r.user_code = u.user_code
        JOIN rental_cars rc ON r.car_code = rc.car_code
        JOIN car_types ct ON rc.car_type_code = ct.car_type_code
        JOIN branchs rl ON r.rental_location = rl.branch_code
        WHERE 1=1
        <if test="rentalLocationName != null and rentalLocationName != ''">
            AND rl.branch_name = #{rentalLocationName}
        </if>
        <if test="rentalDate != null and rentalDate != ''">
            AND r.rental_date = DATE_FORMAT(#{rentalDate}, '%Y%m%d')
        </if>
        <if test="userName != null and userName != ''">
            AND u.user_name = #{userName}
        </if>
    </select>

    <select id="countAllReservations" resultType="int">
        SELECT COUNT(*) FROM reservations
    </select>
</mapper>
